# Commandes de diagnostic et gestion Traefik

# Check Traefik status
k8-traefik-status: k8-require-env
  @echo "ğŸ” Traefik status:"
  kubectl get pods -n traefik-system
  @echo ""
  @echo "ğŸ“Š Traefik services:"
  kubectl get svc -n traefik-system
  @echo ""
  @echo "ğŸŒ Ingress resources:"
  kubectl get ingress -A

# VÃ©rifier l'Ã©tat complet de Traefik (dÃ©taillÃ©)
k8-traefik-status-detailed: k8-require-env
  @echo "ğŸ” Ã‰tat dÃ©taillÃ© de Traefik..."
  @echo ""
  @echo "ğŸ“‹ Pods Traefik actuels:"
  kubectl get pods -n traefik-system -l app.kubernetes.io/name=traefik
  @echo ""
  @echo "ğŸ“‹ Service LoadBalancer:"
  kubectl get service traefik -n traefik-system
  @echo ""
  @echo "ğŸ“‹ Deployment Traefik:"
  kubectl get deployment traefik -n traefik-system
  @echo ""
  @echo "ğŸ“‹ ReplicaSet Traefik:"
  kubectl get replicaset -n traefik-system -l app.kubernetes.io/name=traefik

# RedÃ©marrer Traefik proprement
k8-traefik-restart: k8-require-env
  @echo "ğŸ”„ RedÃ©marrage de Traefik..."
  kubectl rollout restart deployment/traefik -n traefik-system
  @echo "â³ Attente du redÃ©marrage..."
  kubectl rollout status deployment/traefik -n traefik-system --timeout=300s
  @echo "âœ… Traefik redÃ©marrÃ© avec succÃ¨s"

# Traefik logs
k8-traefik-logs: k8-require-env
  @echo "ğŸ“‹ Traefik logs:"
  kubectl logs -f -l app.kubernetes.io/name=traefik -n traefik-system

# VÃ©rifier les logs Traefik pour diagnostiquer les problÃ¨mes (sans follow)
k8-traefik-logs-recent: k8-require-env
  @echo "ğŸ“ Logs Traefik rÃ©cents..."
  kubectl logs -n traefik-system -l app.kubernetes.io/name=traefik --tail=50

# Logs Traefik
k8-traefik-logs-follow: k8-require-env
  @echo "ğŸ“‹ Traefik logs (follow mode):"
  kubectl logs -f -l app.kubernetes.io/name=traefik -n traefik-system --tail=100

# VÃ©rifier les Ã©vÃ©nements du namespace traefik-system
k8-traefik-events: k8-require-env
  @echo "ğŸ“‹ Ã‰vÃ©nements rÃ©cents du namespace traefik-system:"
  kubectl get events -n traefik-system --sort-by='.lastTimestamp' --field-selector type!=Normal

# Test de connectivitÃ© LoadBalancer
k8-traefik-test-connectivity: k8-require-env
  @echo "ğŸŒ Test de connectivitÃ© LoadBalancer..."
  @echo ""
  @echo "ğŸ“‹ Hostname externe attribuÃ©:"
  kubectl get service traefik -n traefik-system -o jsonpath='{.status.loadBalancer.ingress[0].hostname}'
  @echo ""
  @echo ""
  @echo "ğŸ”— Test HTTP (attention: peut Ã©chouer si pas encore configurÃ©):"
  @LB_IP=$(kubectl get service traefik -n traefik-system -o jsonpath='{.status.loadBalancer.ingress[0].hostname}'); \
  if [ ! -z "$LB_IP" ]; then \
    echo "Tentative de connexion Ã  $LB_IP:80..."; \
    curl -I "http://$LB_IP" --connect-timeout 5 2>/dev/null || echo "âŒ Pas de rÃ©ponse (normal si Ingress pas encore configurÃ©)"; \
  else \
    echo "âŒ Pas d'IP externe attribuÃ©e"; \
  fi

# Diagnostic complet - Ã  utiliser pour rÃ©soudre les problÃ¨mes
k8-traefik-diagnose: k8-require-env
  @echo "ğŸ” DIAGNOSTIC COMPLET TRAEFIK"
  @echo "=============================="
  @echo ""
  just k8-traefik-status-detailed
  @echo ""
  @echo "ğŸ“‹ Ã‰vÃ©nements rÃ©cents:"
  just k8-traefik-events
  @echo ""
  @echo "ğŸ“ Logs rÃ©cents:"
  just k8-traefik-logs-recent
  @echo ""
  @echo "ğŸŒ Test connectivitÃ©:"
  just k8-traefik-test-connectivity