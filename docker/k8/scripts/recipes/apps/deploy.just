# DÃ©ploiement des applications basÃ© sur l'environnement courant (K8_ENV)
k8-deploy-apps: k8-require-env
  #!/bin/bash
  set -e

  # K8_ENV doit Ãªtre dÃ©fini - faire planter sinon
  if [ -z "$K8_ENV" ]; then
    echo "âŒ Les variables d'environnements ne sont pas chargÃ©es"
    echo "   Utilisez des secrets ou \`just k8-check-env {env name}\`"
    exit 1
  fi

  ENV="$K8_ENV"
  OVERLAY_PATH="docker/k8/apps/overlays/$ENV"

  echo "â˜¸ï¸ DÃ©ploiement des applications Scenaro Voice Agent"
  echo "ğŸ“‹ Environnement: $ENV"
  echo "ğŸ“‚ Overlay utilisÃ©: $OVERLAY_PATH"

  # VÃ©rification que l'overlay existe
  if [ ! -d "$OVERLAY_PATH" ]; then
    echo "âŒ Overlay non trouvÃ©: $OVERLAY_PATH"
    echo "   VÃ©rifiez dans le dossier apps/overlays"
    exit 1
  fi

  # DÃ©ploiement via Kustomize
  echo ""
  echo "ğŸš€ DÃ©ploiement des applications..."
  kubectl apply -k "$OVERLAY_PATH"

  echo ""
  echo "â³ Attente de la finalisation des dÃ©ploiements..."
  kubectl rollout status deployment/agent -n "$K8S_NAMESPACE" --timeout=300s
  kubectl rollout status deployment/front -n "$K8S_NAMESPACE" --timeout=300s

  echo ""
  echo "ğŸ” VÃ©rification de l'Ã©tat des services..."
  kubectl get pods -n "$K8S_NAMESPACE" -o wide
  kubectl get services -n "$K8S_NAMESPACE"

  echo ""
  echo "âœ… Applications dÃ©ployÃ©es avec succÃ¨s dans l'environnement '$ENV'!"
  echo "ğŸŒ Namespace: $K8S_NAMESPACE"

# Management

# Restart avec confirmation
k8-restart: k8-require-env
  @read -p "Continue? (y/n): " answer; \
    if [ "$$answer" != "y" ]; then echo "Abandon de la commande."; exit 1; fi

  @echo "ğŸ”„ Restarting deployments to pick up new changes..."
  kubectl rollout restart deployment/agent -n scenaro-voice-agent
  kubectl rollout restart deployment/front -n scenaro-voice-agent
  @echo "â³ Waiting for restart to complete..."
  kubectl rollout status deployment/agent -n scenaro-voice-agent
  kubectl rollout status deployment/front -n scenaro-voice-agent

# Rollback du dÃ©ploiement
k8-rollback: k8-require-env
  @echo "ğŸ”„ Rolling back to previous deployment..."
  kubectl rollout undo deployment/agent -n scenaro-voice-agent
  kubectl rollout undo deployment/front -n scenaro-voice-agent
  @echo "â³ Waiting for rollback to complete..."
  kubectl rollout status deployment/agent -n scenaro-voice-agent
  kubectl rollout status deployment/front -n scenaro-voice-agent

# Scaling des deployments (provilÃ©gier le GitOps)
k8-scale replicas="2": k8-require-env
  @echo "ğŸ“ˆ Scaling deployments to {{replicas}} replicas..."
  kubectl scale deployment/agent --replicas={{replicas}} -n scenaro-voice-agent
  kubectl scale deployment/front --replicas={{replicas}} -n scenaro-voice-agent
  @echo "â³ Waiting for scaling to complete..."
  kubectl rollout status deployment/agent -n scenaro-voice-agent
  kubectl rollout status deployment/front -n scenaro-voice-agent

# Scaling agent (provilÃ©gier le GitOps)
k8-scale-agent replicas="2": k8-require-env
  @echo "ğŸ“ˆ Scaling deployments to {{replicas}} replicas..."
  kubectl scale deployment/agent --replicas={{replicas}} -n scenaro-voice-agent
  @echo "â³ Waiting for scaling to complete..."
  kubectl rollout status deployment/agent -n scenaro-voice-agent

# Scaling front (provilÃ©gier le GitOps)
k8-scale-front replicas="2": k8-require-env
  @echo "ğŸ“ˆ Scaling (front) deployments to {{replicas}} replicas..."
  kubectl scale deployment/front --replicas={{replicas}} -n scenaro-voice-agent
  @echo "â³ Waiting for scaling (front) to complete..."
  kubectl rollout status deployment/front -n scenaro-voice-agent

# Nettoyage complet du cluster
k8-cleanup: k8-require-env
  @echo "ğŸ§¹ Cleaning up Kubernetes resources..."
  @echo "âš ï¸  This will delete ALL resources in the scenaro-voice-agent namespace"
  @read -p "Continue? (y/n): " confirm && [ "$$confirm" = "y" ] || exit 1
  kubectl delete namespace scenaro-voice-agent
  @echo "âœ… Cleanup completed!"

k8-delete-pod-front: k8-require-env
  @echo "ğŸ§¹ Deleting pod front..."
  kubectl delete pods -n scenaro-voice-agent -l app=front --force;
  @echo "âœ… Pod front deleted!"



